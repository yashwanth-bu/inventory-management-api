# Inventory Management API Documentation [VERSION 0.0.1]

## 1. Project Overview

* CRUD operations on inventories
* Soft delete & recovery
* Auto-permanent deletion after 30 days (cron)
* Validation & structured API responses

---

## 2. Project Structure

```
src/
 ├─ config/
 │   ├─ prisma.client.js      # Prisma client
 │   └─ env.js               # Environment config
 ├─ cron/
 │   └─ inventory.cleanup.js  # Cron job for permanent deletion
 ├─ middleware/
 │   ├─ async.handler.js      # Async wrapper
 │   ├─ error.handler.js      # Global error handler
 │   └─ router.error.js       # 404 handler
 ├─ modules/
 │   └─ inventory/
 │       ├─ inventory.model.js       # Zod schemas
 │       ├─ inventory.service.js     # Prisma DB functions
 │       ├─ inventory.controller.js  # API controllers
 │       └─ inventory.router.js      # Routes
 ├─ utils/
 │   ├─ send.response.js             # Custom API response
 │   ├─ zod.errors.js                # Zod error formatter
 │   └─ prisma.errors.js             # Prisma error handler
 ├─ server.js                        # Express server
 └─ package.json
```

---

## 3. Database Model (Prisma)

```prisma
model Inventory {
  id        String   @id @default(uuid())
  name      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@unique([name, deletedAt])
}
```

**Notes:**

* `deletedAt` is for **soft delete**
* `name` is unique → allows lookup by name

---

## 4. Zod Schemas

### Create Inventory

```js
export const registerInventorySchema = z.object({
  name: z.string({ required_error: "INVENTORY_NAME_REQUIRED" })
    .min(2, "LEAST_CHAR_ERROR")
});
```

### Update Inventory

```js
export const updateInventorySchema = createInventorySchema.partial();
```

* `.partial()` → makes all fields optional, so you can update just one field

---

## 5. Prisma Service Functions (Updated)

* `getAllInventories()` → returns all **active inventories** (`deletedAt = null`)
* `getInventoryById(id)` → returns a single inventory by ID
* `findFirstInventoryByName(name)` → lookup by unique name among **active inventories** (`deletedAt = null`)
* `createInventory(data)` → create new inventory; respects compound unique `[name, deletedAt]`
* `updateInventory(id, data)` → partial update; handles **Prisma P2002** if renaming to an existing active name
* `deleteInventory(id)` → soft delete (`deletedAt = now()`)
* `uniqueInventoryByID(id)` → returns an inventory by ID (used in recovery)
* `existingActiveInventory(name)` → checks if **an active inventory exists with the same name** (used in recovery to prevent conflicts)
* `recoverInventory(id)` → recovers a soft-deleted inventory; **fails safely if another active inventory with same name exists**
* `getDeletedInventories()` → list all **soft-deleted inventories** (`deletedAt != null`)
* `permanentlyDeleteOldInventories()` → permanently deletes inventories **soft-deleted more than 30 days ago**

---

## 6. Controllers

* **CRUD Operations**

  * `createInventoryController` → POST `/api/inventory`
  * `updateInventoryController` → PATCH `/api/inventory/:id`
  * `deleteInventoryController` → DELETE `/api/inventory/:id`
  * `recoverInventoryController` → PATCH `/api/inventory/:id/recover`

* **Read Operations**

  * `getAllInventoriesController` → GET `/api/inventory` (supports `?name=...`)
  * `getInventoryByIdController` → GET `/api/inventory/:id`
  * `getDeletedInventoriesController` → GET `/api/inventory/deleted`
  * `getInventoryByNameController` → GET `/api/inventory/by-name/:name` (optional)

**Note:** Controllers use `asyncHandler` and `sendResponse` for structured JSON responses.

---

## 7. Routes

```js
router.get("/", getAllInventoriesController);
router.get("/deleted", getDeletedInventoriesController);
router.get("/by-name/:name", getInventoryByNameController);
router.get("/:id", getInventoryByIdController);

router.post("/", createInventoryController);
router.patch("/:id", updateInventoryController);
router.delete("/:id", deleteInventoryController);
router.patch("/:id/recover", recoverInventoryController);
```

---

## 8. Middleware

* **async.handler.js** → wraps async functions to catch errors
* **error.handler.js** → handles all errors and formats response
* **router.error.js** → catches 404 unknown routes

---

## 9. Cron Job

**Purpose:** Permanently delete inventories soft-deleted for more than 30 days.

```js
cron.schedule("0 2 * * *", async () => {
  await permanentlyDeleteOldInventories();
});
```

* Runs daily at 2 AM
* Safe: ignores active inventories

---

## 10. API Response Format

```json
{
  "success": true,
  "message": "INVENTORY_CREATED",
  "data": { ... },
  "meta": null,
  "errorCode": null
}
```

* `success` → boolean
* `message` → status or custom message
* `data` → payload (object or array)
* `meta` → optional metadata
* `errorCode` → optional internal error code

---

## 11. Example Requests

### Create Inventory

```http
POST /api/inventory
Content-Type: application/json

{
  "name": "Laptop",
  "quantity": 5,
  "price": 1200
}
```

### Update Inventory (partial)

```http
PATCH /api/inventory/:id
Content-Type: application/json

{
  "name": "T-Shirts-Cart"
}
```

### Soft Delete

```http
DELETE /api/inventory/:id
```

### Recover

```http
PATCH /api/inventory/:id/recover
```

### Get All Inventories (filter by name)

```http
GET /api/inventory?name=Laptop
```

### Get Deleted Inventories

```http
GET /api/inventory/deleted
```

---

## 12. Error Handling

* **Zod validation errors** → 400
* **Prisma unique violation** → 409
* **Not found (update/delete)** → 404
* **Internal server errors** → 500

---

## 13. Server Setup (`server.js`)

```js
import express from "express"
import helmet from "helmet";
import morgan from "morgan";

import inventoryRouter from "./modules/inventory/inventory.router.js"
import errorHandler from './middleware/error.handler.js'
import routerError from './middleware/router.error.js'

import "./cron/inventory.cleanup.js";

const server = express()

server.use(express.json())

server.use(helmet());

server.use(morgan("dev"));

server.get("/api/health", function (req, res) {
  res.status(200).json({ status: "OK" });
});

server.use("/api/inventory", inventoryRouter)

server.use(routerError)

server.use(errorHandler)

export default server;
```

---

## 14. Notes & Best Practices

1. Use **`.partial()`** for update schemas
2. **Soft delete** + **recovery** keeps DB safe
3. **Cron job** automates cleanup
4. Use **query parameters for search** (`?name=...`)
5. **Controllers are thin** — all DB logic in service layer
6. Global error handling centralizes responses

---