# Authentication Module Documentation

## 1. Overview

This module implements **user authentication** for a Node.js backend using **Express**, **Passport.js**, **Prisma ORM**, **Zod validation**, and **bcrypt** for password hashing. It supports:

* User registration
* User login
* User logout
* Session management
* Input validation
* Security best practices (password hashing, CORS handling)

---

## 2. Folder & File Structure

```
auth/
│
├─ auth.controller.js      # Handles API requests for auth
├─ auth.model.js           # Zod schemas for validation
├─ auth.service.js         # Database interactions via Prisma
├─ passport.config.js      # Passport strategies & serialization
├─ strategies/
│   └─ local.strategy.js   # Local login strategy
├─ auth.routes.js          # Express routes
middleware/
├─ auth.middleware.js      # Checks if user is authenticated
├─ zod.validation.js       # Middleware to validate requests
├─ async.handler.js        # Wraps async functions to handle errors
utils/
├─ send.response.js        # Standardized API response handler
config/
├─ prisma.client.js        # Prisma client configuration
```

---

## 3. Dependencies

* **Express** – web framework
* **Passport.js** – authentication library
* **Passport-local** – local username/password strategy
* **Prisma** – ORM for database operations
* **Zod** – schema validation
* **bcrypt** – password hashing
* **cors** – cross-origin requests handling

---

## 4. Functionality

### 4.1 User Registration

* **Route:** `POST /register`
* **Validation:** `UserRegisterSchema`
* **Flow:**

  1. Validate incoming email and password.
  2. Check if the email is already registered.
  3. Hash the password with bcrypt.
  4. Store the user in the database.
  5. Return a success response.

### 4.2 User Login

* **Route:** `POST /login`
* **Validation:** `UserLoginSchema`
* **Flow:**

  1. Authenticate using Passport's local strategy.
  2. Compare the provided password with hashed password in DB.
  3. Serialize user into session.
  4. Return a success response.

### 4.3 User Logout

* **Route:** `DELETE /logout`
* **Flow:**

  1. Check if user is authenticated.
  2. Destroy the session.
  3. Return a success response.

---

## 5. Passport Local Strategy

### 5.1 LocalStrategy

* Uses **email** as username field.
* Verifies:

  * User exists in database
  * Password matches hashed password
* Returns user object on success.

### 5.2 Serialization / Deserialization

* **serializeUser:** Stores user ID in session
* **deserializeUser:** Retrieves full user object from ID

---

## 6. Validation with Zod

* **UserRegisterSchema:**

  * `email`: required, valid email
  * `password`: required, min 8 characters, must include lowercase, uppercase, number, special character
* **UserLoginSchema:**

  * `email` and `password`: required
* **Middleware:** `validateZod` sanitizes request body and ensures data matches schema

---

## 7. Middleware

### 7.1 Authentication Check

```javascript
function isAuthenticated(req, res, next){
  if (req.isAuthenticated && req.isAuthenticated()) {
    return next();
  }
  res.status(401);
  return next(new Error("UNAUTHORIZED"));
}
```

* Ensures only authenticated users can access protected routes.

### 7.2 CORS Handling

* Only allows requests from `http://localhost:3000` and `https://yourfrontend.com`
* Supports credentials, preflight requests, and standard HTTP methods.

---

## 8. Database Operations (Prisma)

* `findUserByEmail(email)` – returns user by email
* `findUserById(id)` – returns user by ID
* `createUser(data)` – creates a new user record

---

## 9. Error Handling

* Uses **asyncHandler** to wrap async functions and forward errors to Express error middleware
* Common errors:

  * `USER_ALREADY_TAKEN` – email already registered
  * `INVALID_CREDENTIALS` – incorrect email/password
  * `UNAUTHORIZED` – access to protected route without login
  * `CREDENTIALS_REQUIRED` – missing login fields

---

## 10. Sample API Requests

### Register

```http
POST /register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "Password123!"
}
```

**Response:**

```json
{
  "message": "USER_CREATED"
}
```

### Login

```http
POST /login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "Password123!"
}
```

**Response:**

```json
{
  "message": "LOGIN_SUCCESSFUL"
}
```

### Logout

```http
DELETE /logout
Authorization: Bearer <session-cookie>
```

**Response:**

```json
{
  "message": "LOGOUT_SUCCESSFUL"
}
```

---

## 11. Security Measures

* Passwords hashed using **bcrypt** before storing
* Input validated and sanitized via **Zod**
* Sessions managed via **Passport**
* CORS restricted to trusted origins

---